import pefile
import os
import shutil
from os import listdir
from os.path import isfile, join
import shutil
import os
import pandas as pd

malwr_file_names = [f for f in listdir("MALWR") if isfile(
    join("MALWR", f)) if f != ".DS_Store"]

for file_name in malwr_file_names:
    target_file_name = file_name+""
    pe = pefile.PE("MALWR/"+file_name)
    needs_unpack = False
    for section in pe.sections:
        if "UPX" in section.Name.decode(errors='replace',):
            needs_unpack = True
    if needs_unpack:
        target_file_name += "_unpacked"
        os.system("upx -d " + "MALWR/"+file_name)

    original = "MALWR/"+file_name
    target = "CLEAN/"+target_file_name
    shutil.copyfile(original, target)

clean_file_names = [f for f in listdir("CLEAN") if isfile(
    join("CLEAN", f)) if f != ".DS_Store"]

malwr_texts = []
names = []
for file_name in clean_file_names:
    pe = pefile.PE("CLEAN/"+file_name)
    names.append(file_name)
    needs_unpack = False
    sections_text = "Sections:\n"
    for section in pe.sections:

        needs_unpack = True
        sections_text += f"{section.Name} Section address:{hex(section.VirtualAddress)} Section Size:{section.SizeOfRawData}\n"

        # print(section.Name, hex(section.VirtualAddress), hex(section.Misc_VirtualSize), section.SizeOfRawData)
        # print(section.Name.decode(errors='replace',).rstrip('\x00'))

    # print("Size of image ", pe.OPTIONAL_HEADER.SizeOfImage)
    # print("ImageBase ", pe.OPTIONAL_HEADER.ImageBase)
    ddl_text = "DDL:\n"
    for entry in pe.DIRECTORY_ENTRY_IMPORT:
        # print('Llamadas DLL:')
        # print (entry.dll)
        ddl_text += f"{entry.dll}\napi:"
        # print('Llamadas a funciones:')
        for function in entry.imports:
            ddl_text += f"{function.name}\n"
            # print ('\t', function.name)
    # print("TimeDateStamp : " + pe.FILE_HEADER.dump_dict()['TimeDateStamp']['Value'].split('[')[1][:-1])
    times_stamp = f"Timestamp: {pe.FILE_HEADER.dump_dict()['TimeDateStamp']['Value'].split('[')[1][:-1]}"
    malwr_texts.append(sections_text+ddl_text+times_stamp)
df = pd.DataFrame(data={"names": names, "descriptions": malwr_texts})
df.to_csv('dataset.csv')
